<div class="search-container">
  <nav class="navbar">
    <div class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="logo-icon">
        <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
      </svg>
      <span>GameLibrary</span>
    </div>

    <div class="controls-container">
      <div class="search-bar">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input class="search-input" type="text" (input)="onSearch($event)" placeholder="Buscar juego..." aria-label="Buscar juego">
      </div>

      <div class="filter-container">
        <svg class="filter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
        </svg>
        <select id="sort-by" class="sort-select" (change)="onSortChange($event)" aria-label="Ordenar por">
          <option value="relevance">Relevancia</option>
          <option value="name-asc">Nombre (A-Z)</option>
          <option value="name-desc">Nombre (Z-A)</option>
          <option value="date-desc">Fecha (Nuevos)</option>
          <option value="date-asc">Fecha (Antiguos)</option>
          <option value="rating-desc">Valoración (Mejores)</option>
        </select>
      </div>

      <div class="filter-container">
        <svg class="filter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7v2H8v2h8v-2h-2v-2h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H3V4h18v12z"/>
        </svg>
        <select id="platform-filter" class="sort-select" (change)="onPlatformFilterChange($event)" aria-label="Filtrar por plataforma">
          <option value="all">Todas las plataformas</option>
          @if (platforms$ | async; as platforms) {
            @for (platform of platforms; track platform.id) {
              <option [value]="platform.id">{{ platform.name }}</option>
            }
          }
        </select>
      </div>
    </div>

    <div class="auth-controls">
      @if (isAuthenticated$ | async) {
        <button class="auth-button logout" (click)="logout()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="auth-icon">
            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
          </svg>
          <span>Logout</span>
        </button>
      } @else {
        <button class="auth-button login" (click)="openLoginModal()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="auth-icon">
            <path d="M11 7l-1.41 1.41L12.17 11H2v2h10.17l-2.58 2.58L11 17l5-5zM20 19h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
          </svg>
          <span>Login</span>
        </button>
      }
    </div>
  </nav>

  @if (isSearching$ | async) {
    <div class="section-container">
      <h2 class="section-title">Resultados para "{{ lastSearchTerm }}"</h2>
      @if (searchResults$ | async; as games) {
        @if (hasResults) {
          <ul class="results-list">
            @for (game of games; track game.id) {
              <li class="game-item" (click)="openModal(game)">
                <div class="card-image-container">
                  <img [src]="game.coverImageUrl" src="" alt="{{ game.name }} cover" class="game-cover">
                  @if (game.rating) {
                    <div class="card-rating">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="star-icon">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                      </svg>
                      <span>{{ game.rating | number:'1.1-1' }}</span>
                    </div>
                  }
                </div>
                <div class="game-info">
                  <h3 class="game-name">{{ game.name }}</h3>
                  @if (game.releaseDate) {
                    <p class="game-release-date">
                      {{ game.releaseDate | date: 'yyyy' }}
                    </p>
                  }
                  @if (game.platforms; as platforms) {
                    <div class="game-platforms">
                      @for (platform of platforms.slice(0, 3); track platform) {
                        <span class="platform-tag">{{ platform }}</span>
                      }
                      @if (platforms.length > 3) {
                        <span class="platform-more">+{{ platforms.length - 3 }}</span>
                      }
                    </div>
                  }
                </div>
              </li>
            }
          </ul>
        } @else {
          <div class="no-results">
            <p>No se encontraron juegos para "<strong>{{ lastSearchTerm }}</strong>"</p>
          </div>
        }
      }
    </div>
  }

  <div class="section-container">
    <h2 class="section-title">Últimos Lanzamientos</h2>
    @if (latestGames$ | async; as games) {
      <ul class="results-list">
        @for (game of games; track game.id) {
          <li class="game-item" (click)="openModal(game)">
            <div class="card-image-container">
              <img [src]="game.coverImageUrl" src="" alt="{{ game.name }} cover" class="game-cover">
              @if (game.rating) {
                <div class="card-rating">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="star-icon">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                  </svg>
                  <span>{{ game.rating | number:'1.1-1' }}</span>
                </div>
              }
            </div>
            <div class="game-info">
              <h3 class="game-name">{{ game.name }}</h3>
              @if (game.releaseDate) {
                <p class="game-release-date">
                  {{ game.releaseDate | date: 'yyyy' }}
                </p>
              }
              @if (game.platforms; as platforms) {
                <div class="game-platforms">
                  @for (platform of platforms.slice(0, 3); track platform) {
                    <span class="platform-tag">{{ platform }}</span>
                  }
                  @if (platforms.length > 3) {
                    <span class="platform-more">+{{ platforms.length - 3 }}</span>
                  }
                </div>
              }
            </div>
          </li>
        }
      </ul>
    }
  </div>

  <footer class="footer">
    <p>Creado por Francisco José Soler Conchello º 2026</p>
  </footer>

  <!-- Game Details Modal -->
  @if (selectedGame) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="stopPropagation($event)">
        <button class="close-button" (click)="closeModal()" aria-label="Cerrar detalles">&times;</button>

        <div class="modal-header">
          <img [src]="selectedGame.coverImageUrl" src="" alt="{{ selectedGame.name }}" class="modal-cover">
          <div class="modal-title-info">
            <div class="modal-top-row">
              <h2>{{ selectedGame.name }}</h2>
              @if (selectedGame.rating) {
                <div class="modal-rating">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="star-icon-large">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                  </svg>
                  <span>{{ selectedGame.rating | number:'1.1-1' }}</span>
                </div>
              }
            </div>

            @if (selectedGame.releaseDate) {
              <p class="modal-date">
                Lanzamiento: {{ selectedGame.releaseDate | date: 'longDate' }}
              </p>
            }

            @if (selectedGame.genres; as genres) {
              <div class="game-genres modal-genres">
                @for (genre of genres; track genre) {
                  <span class="genre-tag">{{ genre }}</span>
                }
              </div>
            }

            @if (selectedGame.platforms; as platforms) {
              <div class="modal-platforms">
                <span class="platforms-label">Plataformas:</span>
                @for (platform of platforms; track platform) {
                  <span class="platform-tag-modal">{{ platform }}</span>
                }
              </div>
            }
          </div>
        </div>

        <div class="modal-body">
          @if (selectedGame.summary) {
            <div class="modal-section">
              <h3>Descripción</h3>
              <p>{{ selectedGame.summary }}</p>
            </div>
          }

          @if (selectedGame.screenshots?.length) {
            <div class="modal-section">
              <h3>Galería</h3>
              <div class="screenshots-grid">
                @for (screenshot of selectedGame.screenshots; track screenshot) {
                  <img [src]="screenshot" src="" alt="Screenshot" class="screenshot-img" (click)="openLightbox(screenshot)">
                }
              </div>
            </div>
          }

          @if (selectedGame.videos?.length) {
            <div class="modal-section">
              <h3>Vídeos</h3>
              <div class="video-grid">
                @for (videoUrl of selectedGame.videos; track videoUrl) {
                  <div class="video-container">
                    @if (!areVideosPaused) {
                      <iframe
                        [src]="getSafeVideoUrl(videoUrl)"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                      </iframe>
                    } @else {
                      <img [src]="getVideoThumbnail(videoUrl)" alt="Video thumbnail" class="video-thumbnail">
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Screenshot Lightbox -->
  @if (enlargedScreenshot) {
    <div class="lightbox-overlay" (click)="closeLightbox()">
      <img [src]="enlargedScreenshot" src="" alt="Enlarged screenshot" class="lightbox-image">
      <button class="close-button lightbox-close-button" (click)="closeLightbox()" aria-label="Cerrar imagen">&times;</button>
    </div>
  }

  <!-- Login Modal -->
  @if (showLoginModal) {
    <div class="modal-overlay" (click)="closeLoginModal()">
      <div class="modal-content login-modal-content" (click)="stopPropagation($event)">
        <button class="close-button" (click)="closeLoginModal()" aria-label="Cerrar login">&times;</button>
        <app-login></app-login>
      </div>
    </div>
  }
</div>
